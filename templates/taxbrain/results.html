{% extends 'taxbrain/input_base.html' %}
{% load staticfiles %}
{% load flatblocks %}
{% block style %}
{% load results %}
{{block.super}}
<link href="{% static 'css/vendor/bootstrap3-block-grid.min.css' %}" rel="stylesheet">
<link href="{% static 'js/vendor/DataTables/datatables.min.css' %}" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.2/css/responsive.dataTables.css"/>
<style>
  .btn {
    color: black;
  }
  .text-white {
    color: white;
  }
  .table > thead > tr > th {
    border: 0;
  }
  .single-line {
    white-space: nowrap;
  }
  .param-text {
      margin-left: 80px;
      margin-right: 80px;
      margin-top: 40px;
      margin-bottom: 40px;
      text-align: left;
  }
  .file-contents{
      font-family: "Courier New", Courier, monospace;
      font-weight: bold;
      margin-left: 80px;
      margin-right: 80px;
      margin-top: 40px;
      margin-bottom: 40px;
      text-align: left;
  }
  .dataTables_wrapper {
    width: 75%;
  }
  .container {
    width: 95%;
  }
  .output {
    display: none;
  }
  .output:first-child {
    display: block;
  }
  .container > .row {
    padding: 10px 0;
  }
  .output h1 {
    text-transform: uppercase;
  }
  .nav-pills li {
    padding-top: 40px;
  }
  .nav-pills li:first-child {
    padding-top: 0;
  }
</style>
{% endblock %}
{% block content %}
<div class="wrapper">
  {% include 'taxbrain/header.html' %}
  <div class="result-header">
    <div class="result-header-control">
      {% if results_type == "static" %}
        <h1>Static Results</h1>
      {% else %}
        <h1>Partial Equilibrium Results</h1>
      {% endif %}
    </div>
    <p class="meta">These results were generated by <a href="https://github.com/OpenSourcePolicyCenter/webapp-public/tree/v{{webapp_version}}"> PolicyBrain version {{ webapp_version }}</a>  on {{ created_on|date:"D, M jS Y \a\t g:iA" }} UTC using <a href="https://github.com/open-source-economics/Tax-Calculator/tree/{{upstream_version}}"> Tax-Calculator version {{ upstream_version }}.</a> </p>
    {% if quick_calc %}
    <p class="meta">This calculation used only a small sample of the available data and only calculated revenues for one year instead of ten. For the full results, <a href="/taxbrain/submit/{{ unique_url.pk }}/">click here</a></p>

    {% endif %}
    {% if is_behavior %}
    <p class="meta">The microsimulation upon which this dynamic simulation was based can be found <a href="{{microsim_url}}">here</a> </p>
    {% endif %}
    <div class="result-table">
      <div class="result-table-controls">
        {% if is_micro and not is_from_file %}
        <a href="/taxbrain/edit/{{ unique_url.pk }}/?start_year={{ first_year }}" class="text-white btn btn-secondary">Edit Parameters</a>
        {% endif %}
        {% if is_behavior and not is_from_file %}
        <a href="/dynamic/behavioral/edit/{{ unique_url.pk }}/?start_year={{ first_year }}" class="text-white btn btn-secondary">Edit Parameters</a>
        {% endif %}
        {% if is_micro %}
        {% if allow_dyn_links %}
        <button onclick="buttonAction()" class="text-white btn btn-secondary">Link to Dynamic Simulations</button>
        {% endif %}
        {% endif %}
      </div>
      {% if reform_file_contents and assump_file_contents %}
      {% if is_from_file %}
      <h2>The following reform file(s) were uploaded for this simulation: </h2>
      {% else %}
      <h2>The following parameters were used for this simulation: </h2>
      {% endif %}
      <div class="file-contents">
          <h3>Reform</h3>
          {%autoescape off %}
          {{ reform_file_contents | nbsp | linebreaks | safe}}
          {%endautoescape %}
          <h3>Assumptions</h3>
          {%autoescape off %}
          {{ assump_file_contents | nbsp | linebreaks | safe}}
          {%endautoescape %}
      </div>
      {% endif %}
    </div>
  </div>
  <br>
  <div id="table-drilldown-container">
    <div>
      <div class="container">
        <div class="row">
          <div class="col-md-6" id="table-select-container">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title">Build Table</h3>
              </div>
              <div class="panel-body">
                <div class="row">
                  <div class="col-md-6">
                    <h1 class="text-center">For Year: </h1>
                  </div>
                  <div class="col-md-6">
                    <h1 class="text-center">
                      <div class="dropdown dropdown-select dropdown-inline data-switch">
                        {% for year in years %}
                        {% if forloop.first %}
                        <a class="dropdown-toggle" type="button" id="years" data-toggle="dropdown" aria-expanded="true">
                          {{ year }}
                          <span class="caret"></span>
                        </a>
                        {% endif %}
                        <ul class="dropdown-menu" role="menu" aria-labelledby="years">
                          <li role="presentation">
                          <a role="menuitem" tabindex="-1" href="#" data-year="{{ year }}">
                          {{ year }}
                          </a>
                          </li>
                        </ul>
                        {% endfor %}
                      </div>
                    </h1>
                  </div>
                </div>
                {% for tag in tags_flattened %}
                <ul class="nav nav-pills nav-justified{% if tag.hidden %} hidden{% endif %}" id="tag-{{ tag.key }}">
                  {% for value in tag.values %}
                  <li data-tag-{{ tag.key }}="{{ value.value }}" data-children-keys="{% for child in value.children %}{{ child.key }} {% endfor %}"{% if forloop.first %} class="active"{% endif %}><a data-toggle="tooltip" data-placement="bottom" title="{{ value.tooltip }}" href="#">{{ value.title }}</a></li>
                  {% endfor %}
                </ul>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12" id="table-container"></div>
            <div class="panel panel-default">
                <div class="panel-body" style="overflow: scroll">
                  {% for x in outputs %}
                  <div class="output"{% for key, value in x.tags.items %} data-tag-{{ key }}="{{ value }}"{% endfor %}>
                    <h1 class="text-center">{{ x.title }}</h1>
                    {{ x.renderable | safe }}
                  </div>
                  {% endfor %}
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
  <div class="modal fade" id="block-link-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel">Dynamic Simulation Link Unavailable</h4>
        </div>
        <div class="modal-body">
          Oops. Your simulation already had behavioral parameters. You can't link this simulation to a dynamic simulation.
        </div>
        <div class="modal-footer">
          <a type="button" class="btn btn-default" data-dismiss="modal">Got it.</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block bottom_scripts %}
{{ block.super }}
<script src="{% static 'js/vendor/DataTables/datatables.js' %}"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.flash.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.js"></script>
<script>
var buttonAction = function () {
  if ({{allow_dyn_links|yesno:"true,false,true"}} ) {
    window.location.href = "/dynamic/{{ unique_url.pk }}/?start_year={{ first_year }}";
    } else {
    $('#block-link-modal').modal('show');
  }
};
var dataTableOptions = {
  "paging": false,
  "ordering": false,
  "searching": false,
  "bInfo": false,
  'dom': 'tB', /* Display the table before the buttons */
  "buttons": [
    'print',
    'copy',
    'colvis'
  ],
  "language": {
    "buttons": {
      "copy": "Copy table",
      "colvis": 'Select columns'
    }
  }
};
var initDataTable = function (el) {
  var dt = el.dataTable(dataTableOptions);
  dt.parent().find("div.dt-buttons.btn-group").addClass('btn-group-justified');
};
$(document).ready(function () {
  var tables = $('.panel-body table');
  tables.addClass('table').addClass('table-striped');
  initDataTable(tables.first());
  $(".nav li a").click(function (e) {
    /* Toggle the visible selection */
    e.preventDefault();
    var target_li = $(e.target).parent('li');
    target_li.addClass('active');
    var unselected = target_li.parent('.nav').find('li').not(target_li);
    unselected.removeClass('active');

    /* Deactivate child tags for unselected options */
    unselected.each(function (_index, el) {
      var children_keys = $(el).attr('data-children-keys').trim().split(" ");
      $(children_keys.map(function (key) {
          return "#tag-" + key;
        }).join(", "))
        .addClass('hidden');
    });

    /* Activate child tags */
    var children_keys = target_li.attr('data-children-keys').trim().split(" ");
    $(children_keys.map(function (key) {
        return "#tag-" + key;
      }).join(", "))
      .removeClass('hidden');

    /* Get the current set of tags */
    var tags_to_match = {};
    $('.nav:visible li.active').each(function (_index, el) {
      $.each(el.attributes, function (_index, attr) {
        if (attr.name.startsWith('data-tag-')) {
          tags_to_match[attr.name] = attr.value;
        }
      })
    });

    /* Find and display the table matching that set of tags */
    var selector = '.output';
    $.each(tags_to_match, function (key, value) {
      selector += '[' + key + '="' + value + '"]'
    });
    var container_to_show = $(selector);
    var table_to_show = $(selector).find("table").first();
    /* Make sure we don't initialize the DataTable twice */
    if ( ! $.fn.DataTable.isDataTable(table_to_show) ) {
      initDataTable(table_to_show);
    }
    container_to_show.show();
    $('.output').not(container_to_show).hide();
  });
});
</script>


{% endblock %}
